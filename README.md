 flutter_boosté‡‡å‘ & iOSæ··åˆé¡¹ç›®ä¾èµ–FlutterModule

æˆ‘ä»¬çš„é¡¹ç›®ä½¿ç”¨`flutter_boost`æ¥å®ç°iOS & Flutteræ··åˆé¡¹ç›®ï¼Œç›®å‰å·²ç»é€‚é…`3.0.0`ã€‚å› ä¸ºæˆ‘åœ¨`FlutterBoost`çš„å®¹å™¨ä¸Šåˆå°è£…äº†ä¸€å±‚æ§åˆ¶å™¨å®¹å™¨ï¼Œå¯¼è‡´æˆ‘åœ¨ä½¿ç”¨`FlutterBoost`å¼€å‘iOSæ··åˆé¡¹ç›®æ—¶é‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œåœ¨æ­¤æ•´ç†äº†ç›¸å…³çš„é—®é¢˜å’Œè§£å†³æ–¹æ¡ˆã€‚

æ·±æµ…è‰²é€‚é…å’Œ`Push/Present`è¿›å…¥Flutteré¡µé¢æ˜¯æˆ‘åœ¨é¡¹ç›®å¼€å‘ä¸­çœŸå®ç”¨åˆ°çš„åœºæ™¯ï¼Œåœ¨Demoä¸­æˆ‘è¿˜åŸäº†è¿™2ä¸ªåœºæ™¯ï¼Œç»™åŸç”Ÿé¡µé¢å’ŒFlutteré¡µé¢éƒ½é€‚é…äº†æ·±æµ…è‰²ï¼Œå…¶ä¸­çš„æœç´¢é¡µ`SearchPage`å°±æ˜¯Flutteré¡µé¢ï¼Œè€ŒAPPçš„ä¸»é¡µå°±æ˜¯åŸç”Ÿé¡µé¢ï¼ˆå¯ä»¥åˆ‡æ¢æ·±æµ…è‰²ï¼‰ï¼Œå¦å¤–è¿›å…¥`SearchPage`é‡‡ç”¨äº†`Pushã€Present` 2ç§è½¬åœºæ–¹å¼ï¼Œä»¥å¯¹æ¯”æ•ˆæœã€‚


ä¸‹é¢çš„åŠ¨å›¾å°±æ˜¯å®ç°åçš„åˆå§‹æ•ˆæœï¼Œä»”ç»†è§‚å¯Ÿï¼Œå°±å¯ä»¥å‘ç°ä¸‹é¢åˆ—å‡ºçš„å‰2ä¸ªé—®é¢˜ï¼Œå…¶å®ƒçš„é—®é¢˜åˆ™æ˜¯ä»£ç å±‚é¢çš„ã€‚

### 1.é¦–æ¬¡è¿›å…¥Flutteré¡µé¢å‡ºç°ç©ºç™½

ç”±äºç¼ºå°‘ç¼“å­˜ï¼Œå®‰è£…APPåé¦–æ¬¡è¿›å…¥Flutteré¡µé¢ä¼šå‡ºç°çŸ­æš‚çš„ç©ºç™½ï¼Œç„¶åå†æ¸²æŸ“å‡ºFlutterçš„UIï¼Œä¹‹åé‡å¯APPåŸºæœ¬ä¸ä¼šå‡ºç°è¿™ä¸ªé—®é¢˜ã€‚

### 2.åœ¨åŸç”Ÿé¡µé¢åˆ‡æ¢æ·±æµ…è‰²åè¿›å…¥Flutteré¡µé¢ä¼šå…ˆæ¸²æŸ“ä¸Šä¸€æ¬¡çš„é…è‰²æ¨¡å¼

åœ¨APPå†…çš„åŸç”Ÿé¡µé¢åˆ‡æ¢æ·±æµ…è‰²åè¿›å…¥Flutteré¡µé¢ï¼Œä¼šå…ˆæ¸²æŸ“ä¸Šä¸€æ¬¡çš„æ·±æµ…è‰²æ ·å¼ï¼Œå†åˆ‡æ¢å½“å‰çš„é…è‰²ï¼Œå…ˆç™½åé»‘æˆ–è€…å…ˆé»‘åç™½ï¼›


<img src="https://github.com/XiFengLang/flutter_notes/blob/main/assets/ezgif.com-gif-maker.webp" width="50%" height="50%" alt="é—®é¢˜å›¾"/><br/>

å¯¹äºè¿™2ä¸ªé—®é¢˜ï¼Œæˆ‘çš„è§£å†³æ€è·¯æ˜¯ä¸€æ ·çš„ï¼Œå°±æ˜¯æå‰é¢„åŠ è½½ä¸€ä¸ªFlutteré¡µé¢ï¼Œè®©Flutteræå‰å®Œæˆæ¸²æŸ“å’Œç¼“å­˜ã€‚

* é¦–å…ˆæ˜¯åœ¨åˆå§‹åŒ–`FlutterBoost`åé¢„åŠ è½½ä¸€ä¸ªFlutteré¡µé¢ï¼Œå†ç«‹åˆ»(å»¶è¿Ÿ0.6ç§’)å…³æ‰è¿™ä¸ªé¡µé¢ã€‚
* åˆ‡æ¢æ·±æµ…è‰²ä¹‹ååŒæ ·ä¹Ÿé¢„åŠ è½½ä¸€ä¸ªFlutteré¡µé¢ï¼Œç„¶ååˆç«‹åˆ»å…³æ‰è¿™ä¸ªé¡µé¢ï¼Œå®ŒæˆFlutterä¾§çš„æ·±æµ…è‰²æ¸²æŸ“ã€‚

å…·ä½“çš„ä»£ç å‚è€ƒ`[FlutterModuleAgent preloadFlutterModuleAfterDelay:]`å’Œ`@"root_page"`ç©ºç™½é¡µçš„å¤„ç†é€»è¾‘ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ä¸ºäº†ä¸è®©ç”¨æˆ·ä½“å¯Ÿåˆ°è¿™ä¸ªåŠ¨ä½œï¼Œéœ€è¦ç”¨`addChildViewController:flutterVC`çš„æ–¹å¼æŠŠè¿™ä¸ªé¡µé¢æ”¾åœ¨å±å¹•å¤–é¢ï¼Œå³è®¾ç½®`flutterVC.view.frame`ï¼Œè€Œä¸æ˜¯é‡‡ç”¨`push/present`å¸¦è½¬åœºæ–¹å¼ã€‚`push/present`ä¼šæœ‰è½¬åœºåŠ¨æ•ˆï¼Œå³ä½¿æ— åŠ¨æ•ˆä¹Ÿå¯èƒ½å¹²æ‰°åˆ°æ­£å¸¸çš„æ§åˆ¶å™¨æ ˆï¼Œè€Œ`addChildViewController: flutterVC `å’Œ`addSubview:flutterVC.view`åˆ™ç®€å•ç²—æš´çš„å¤šï¼Œå‡ ä¹ä¸ä¼šå½±å“åˆ°ç°æœ‰çš„æ§åˆ¶å™¨æ ˆã€‚

è¿™æ˜¯å¯ç”¨é¢„åŠ è½½ä¹‹åçš„æ•ˆæœï¼Œæ— è®ºæ˜¯é¦–æ¬¡è¿›å…¥Flutteré¡µé¢ï¼Œè¿˜æ˜¯åˆ‡æ¢æ·±æµ…è‰²åè¿›å…¥Flutteré¡µé¢ï¼Œ~~éƒ½ä¸ä¼šæœ‰é—ªç™½å¡é¡¿çš„ç°è±¡~~ï¼Œæµç•…äº†å¾ˆå¤šï¼Œåªæœ‰ç¬¬ä¸€æ¬¡å¯åŠ¨APPè¿›å…¥Flutteré¡µé¢æ‰ä¼šå‡ºç°çŸ­æš‚çš„é—ªç™½ï¼ŒåŸå› è¿˜æœªæ‰¾åˆ°ï¼Œä¸è¿‡å½±å“ä¸å¤§ã€‚

<img src="https://github.com/XiFengLang/flutter_notes/blob/main/assets/ezgif-com-gif-make.webp" width="50%" height="50%" alt="ä¼˜åŒ–å"/><br/>



### 3.flutteré¡µé¢å†…å­˜æ³„æ¼ï¼Œflutteré¡µé¢é€€å‡ºåæ²¡æœ‰è°ƒç”¨dispose

åœ¨`search_page.dart`æ–‡ä»¶`_SearchPageState`ä¸­é‡å†™`dispose()`æ–¹æ³•ï¼Œç›‘å¬é¡µé¢å†…å­˜é‡Šæ”¾ã€‚`search_page`æ˜¯Pushè¿›å…¥çš„ï¼ŒPopé¡µé¢ååŸç”Ÿæ§åˆ¶å™¨è¢«é‡Šæ”¾ï¼Œä½†æ˜¯Flutterä¾§é¡µé¢å¹¶æ²¡æœ‰é‡Šæ”¾ï¼Œæ²¡æœ‰æ‰“å°é¡µé¢å·²é‡Šæ”¾ï¼Œæ£€æŸ¥2ç«¯ä»£ç åå‘ç°é—®é¢˜å‡ºåœ¨åŸç”Ÿä¾§è‡ªå®šä¹‰çš„Flutteræ§åˆ¶å™¨å®¹å™¨ä¸Šã€‚

```C
class _SearchPageState extends State<SearchPage> {
  TextEditingController controller = TextEditingController();
  FocusNode focusNode = FocusNode();

  ...

  @override
  void dispose() {
    print('æœç´¢é¡µå·²é‡Šæ”¾');

    focusNode.dispose();
    controller.dispose();
    super.dispose();
  }
  
  ...
}
```

æˆ‘ä½¿ç”¨çš„é¡µé¢ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œä¹‹æ‰€ä»¥è¿™ä¹ˆåšæ˜¯ä¸ºäº†ç»Ÿä¸€æ§åˆ¶å™¨é¡µé¢çš„æŸäº›ç‰¹æ€§å’Œæ¥å£åŠŸèƒ½ã€‚é€‰æ‹©åœ¨`FBFlutterViewContainer `åŸºç¡€ä¸Šè‡ªå®šä¹‰ä¸€ä¸ªFlutteræ§åˆ¶å™¨å®¹å™¨ï¼Œæœ€åæ‰€æœ‰çš„Flutteré¡µé¢éƒ½ç”±`FlutterModuleViewController`æ‰¿è½½ï¼Œè€Œ`FBFlutterViewContainer`åˆ™æ·»åŠ åœ¨å®¹å™¨`FlutterModuleViewController`ä¸Šï¼Œä½†æ˜¯2è€…ä¸æ˜¯ç»§æ‰¿å…³ç³»ï¼Œè€Œæ˜¯çˆ¶å­æ§åˆ¶å™¨çš„å…³ç³»ã€‚

```C
    FlutterModuleViewController.m

    self.flutterContainer.view.frame = self.view.bounds;
    [self.view insertSubview:self.flutterContainer.view atIndex:0];
    [self addChildViewController:self.flutterContainer];
```

<img src="https://github.com/XiFengLang/flutter_notes/blob/main/assets/flutter_page_container.png"  alt="Flutteræ§åˆ¶å™¨å®¹å™¨"/><br/>

ç”±äºæˆ‘æ¼æ‰äº†`[self.flutterContainer removeFromParentViewController]`ï¼Œå¯¼è‡´äº†`FBFlutterViewContainer`çš„`notifyWillDealloc`é€»è¾‘æ²¡æœ‰æ‰§è¡Œï¼ŒFlutterä¾§æ²¡æœ‰ç§»é™¤æ‰å¯¹åº”çš„é¡µé¢Widgetï¼Œä¹Ÿå°±ä¸ä¼šè°ƒç”¨`dispose()`ã€‚äºæ˜¯é‡å†™äº†`didMoveToParentViewController:`æ–¹æ³•ï¼Œé€€å‡ºæ§åˆ¶å™¨æ—¶è°ƒç”¨`[self.flutterContainer removeFromParentViewController]`ï¼Œä»¥è§¦å‘`notifyWillDealloc`é€»è¾‘ï¼Œå®ŒæˆFlutterä¾§çš„å†…å­˜é‡Šæ”¾ã€‚

```C
FlutterModuleViewController.m

- (void)didMoveToParentViewController:(UIViewController *)parent {
    /// MARK: ä¸‹é¢è¿™è¡Œä»£ç åœ¨è¿™å„¿ä¼šè§¦å‘2æ¬¡notifyWillDeallocï¼Œä¼šå¯¼è‡´FlutterBoostå‡ºç°å¼‚å¸¸
    /// æ¯”å¦‚ NoSuchMethodError: The getter 'topPage' was called on null.
    /// [self.flutterContainer didMoveToParentViewController:parent];

    /// ä¸‹é¢åªä¼šè§¦å‘ä¸€æ¬¡notifyWillDeallocï¼Œæ­£å¸¸
    if (parent == nil && self.flutterContainer.parentViewController) {
        [self.flutterContainer removeFromParentViewController];
    }
    [super didMoveToParentViewController:parent];
}
```

**ä½†æ˜¯ ä½†æ˜¯ ä½†æ˜¯** æˆ‘åˆå‘ç°`Present`è¿›å…¥`search_page`æ—¶åŒæ ·ä¹Ÿä¼šå‡ºç°å†…å­˜æ³„æ¼ï¼ŒFlutteré¡µé¢æ²¡æœ‰è¢«é‡Šæ”¾ã€‚è°ƒè¯•å‘ç° 'dismissViewControllerAnimated:completion:' å¹¶æ²¡æœ‰è§¦å‘'didMoveToParentViewController:'æ–¹æ³•ï¼ŒğŸ˜“æ€ªè‡ªå·±åŸºç¡€ä¸æ‰å®ã€‚äºæ˜¯åˆåŠ äº†ä¸‹é¢çš„ä»£ç ï¼Œè§£å†³äº†åµŒå¥—`FBFlutterViewContainer`é¡µé¢å‡ºç°çš„å†…å­˜æ³„æ¼é—®é¢˜ã€‚

```C
- (void)dismissViewControllerAnimated:(BOOL)flag completion:(void (^)(void))completion {
    [super dismissViewControllerAnimated:flag completion:^{
        /// MARK: è§£å†³NavigationControlleråµŒå¥—CustomFlutterVCå¯¼è‡´Flutteré¡µé¢ä¸é‡Šæ”¾çš„é—®é¢˜
        /// åŸå› æ˜¯ 'dismissViewControllerAnimated:completion:' å¹¶ä¸ä¼šè§¦å‘ 'didMoveToParentViewController:'æ–¹æ³•
        /// FBFlutterViewContainer æœ‰é‡å†™ 'dismissViewControllerAnimated:completion:' æ–¹æ³•æ¥ç§»é™¤Flutteré¡µé¢
        /// ä½†å¦‚æœFBFlutterVCåˆè¢«åµŒå¥—åœ¨è‡ªå®šä¹‰çš„CustomFlutterVCé‡Œé¢ï¼ŒCustomFlutterVCå°±éœ€è¦å®ç°ç§»é™¤Flutteré¡µé¢çš„é€»è¾‘ï¼Œä¸»åŠ¨è§¦å‘Flutterä¾§å†…å­˜é‡Šæ”¾
        
        [self didMoveToParentViewController:nil];
    }];
}
```





